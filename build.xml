<?xml version="1.0"?>
<project name="" basedir="." default="help"  description="Generate the API for TYPO3">


 	<!-- PROPERTIES DECLARATION -->
	<property name="dryRun" value="${dryRun}"/>
	<property name="force" value="${force}"/>
	<property name="verbose" value=""/>


 	<!-- make sure the file exist with the appropriate configuration -->
	<import file="build.configuration.xml"/>
	
	<!--
	<property name="path.home" value="foo/APIBuilder/"/>
	<property name="path.storage" value="foo/Storage/"/>
	<property name="path.www" value="foo/www/"/>
	<property name="command.doyxgen" value="/usr/bin/doxygen"/>
	-->
	
	<property name="path.build" value="${path.storage}Build/"/>
	<property name="path.source" value="${path.storage}Source/"/>

	<property name="server.credentials" value="api"/>
	<property name="site.remote.directory" value="/var/www/vhosts/api.typo3.org/"/>

<!--
	<property name="path.www" value="/var/www/vhosts/api.typo3.org/www/"/>
	<property name="path.home" value="/var/www/vhosts/api.typo3.org/home/APIBuilder/"/>
	<property name="path.storage" value="/var/www/vhosts/api.typo3.org/home"/>
	<property name="path.build" value="${path.storage}Build/"/>
	<property name="path.source" value="${path.storage}Source/"/>
	<property name="command.doyxgen" value="/usr/bin/doxygen"/>
-->
	<property name="path.build.archive" value="${path.build}Zip/"/>
	<property name="path.build.api" value="${path.build}Api/"/>
	<property name="path.temporary" value="${path.storage}Temporary/"/>


	<!-- RUNNING VARIABLES -->

	<!-- FILE SET -->
	<path id="phingClasses">
		<pathelement dir="Classes/"/>
	</path>

	<!-- TASK DEFINITION -->
	<taskdef name="download" classname="Download" classpathref="phingClasses"/>
	<taskdef name="doxygen" classname="Doxygen" classpathref="phingClasses"/>
	<taskdef name="phpuml" classname="PHPUML" classpathref="phingClasses"/>
	<taskdef name="archive" classname="Archive" classpathref="phingClasses"/>
	<taskdef name="deploy" classname="Deploy" classpathref="phingClasses"/>
	<taskdef name="rsync" classname="Rsync" classpathref="phingClasses"/>
	<taskdef name="commandRemote" classname="CommandRemote" classpathref="phingClasses"/>
	<taskdef name="commandLocal" classname="CommandLocal" classpathref="phingClasses"/>

	<target name="help">
	
		<echo>---------------------------------------------</echo>
		<echo>Usage of this Phing</echo>
		<echo>---------------------------------------------</echo>
		<echo>phing typo3-4-5</echo>
		<echo>phing deploy-typo3-4-5</echo>
		<echo/>
		
		<echo>---------------------------------------------</echo>
		<echo>Obsolete Targets</echo>
		<echo>---------------------------------------------</echo>
		<echo>phing build          - build the API by calling all the necessary ants: bootstrap, download, doxygen, phpuml, zip, deploy</echo>
		<echo>phing bootstrap      - prepare the environment </echo>
		<echo>phing download       - download sources related to different projects linked with TYPO3</echo>
		<echo>phing doxygen        - launch the Doxygen generation process</echo>
		<echo>phing phpuml         - launch the PHP UML generation process</echo>
		<echo>phing archive        - archive the API documentation</echo>
		<echo>phing deploy         - deploy the documentation API, Zip to the document root</echo>
		<echo>phing test           - test whether everything has run correctly (not yet implemented)</echo>
		<echo>phing help           - display this help message</echo>
		<echo>phing reset          - reset the environment by deleting some output folders as API, Archive</echo>
		<echo/>


		<echo>---------------------------------------------</echo>
		<echo>Possible options</echo>
		<echo>---------------------------------------------</echo>
		<echo>-DdryRun=true        - will display the command to be executed</echo>
		<echo>-Dforce=true          - will force the documentation to be regenerated</echo>
	</target>


	<!-- MAIN RUN -->
<!--	<target name="build" depends="bootstrap,download,doxygen,phpuml,archive,deploy" />-->
	<target name="build-phpuml" depends="bootstrap,download,phpuml,archive,deploy" />

	<!-- BOOTSTRAP -->
	<target name="bootstrap" description="Bootstrap the system">
		<echo>----------------------------------------</echo>
		<echo>| Boostrapping environment...           |</echo>
		<echo>----------------------------------------</echo>
		<mkdir dir="${path.build}" />
		<mkdir dir="${path.source}" />
		<mkdir dir="${path.temporary}" />
		<mkdir dir="${path.storage}Logs" />
		<mkdir dir="${path.build.archive}" />
		<mkdir dir="${path.build.api}" />
<!--		<mkdir dir="${path.build.api}Extbase" />
		<mkdir dir="${path.build.api}Fluid" />
		<mkdir dir="${path.build.api}FLOW3" />-->
		<mkdir dir="${path.www}extbase" />
		<mkdir dir="${path.www}fluid" />
		<mkdir dir="${path.www}archives" />
		<mkdir dir="${path.www}flow3" />
		<echo>OK</echo>
	</target>

	<!-- DOWNLOAD SOURCE -->
	<target name="download" depends="">
		<echo>----------------------------------------</echo>
		<echo>| Downloading latest source...         |</echo>
		<echo>----------------------------------------</echo>
		<download />
	</target>
	
	<!-- Doxygen API -->
	<target name="doxygen" depends="">
		<echo>----------------------------------------</echo>
		<echo>| Generating Doxygen documentation...      |</echo>
		<echo>----------------------------------------</echo>
		<doxygen />
	</target>

	<!-- PHP UML API -->
	<target name="phpuml" depends="">
		<echo>----------------------------------------</echo>
		<echo>| Generating PHP UML documentation...   |</echo>
		<echo>----------------------------------------</echo>
		<phpuml />
	</target>

	<!-- ARCHIVE API -->
	<target name="archive" depends="">
		<echo>----------------------------------------</echo>
		<echo>| Creating archives...                 |</echo>
		<echo>----------------------------------------</echo>
		<archive />
	</target>

	<!-- RESET API -->
	<target name="reset" depends="delete,bootstrap" />
	<target name="delete" depends="">
		<echo>----------------------------------------</echo>
		<echo>| Delete somes files...                |</echo>
		<echo>----------------------------------------</echo>

		<commandLocal command="rm -rf ${path.build.api}"/>
		<commandLocal command="rm -rf ${path.build.archive}"/>
	</target>

	<!-- DEPLOY API -->
	<target name="deploy" depends="">
		<echo>----------------------------------------</echo>
		<echo>| Deploying api.typo3.org...            |</echo>
		<echo>----------------------------------------</echo>
		<deploy />
	</target>
	
	
	
	<!-- ************************************ -->
	<!--              TYPO3 4.5               -->
	<!-- ************************************ -->
	<target name="typo3-4-5" depends="bootstrap">
		<echo>----------------------------------------</echo>
		<echo>| Generating TYPO3 4.5 API              |</echo>
		<echo>----------------------------------------</echo>
		
		<property name="version" value="typo3_src-4.5"/>
		<property name="tagName" value="TYPO3_4-5-5"/>
		<property name="tagNameDisplay" value="4.5.5"/>
		<property name="deployPath" value="typo3v4"/>
		<property name="deployPathName" value="45"/>
		<property name="repository" value="git://git.typo3.org/TYPO3v4/Core.git"/>
		
		<!-- Initialize the environment -->
		<mkdir dir="${path.build.api}${version}" />
		<mkdir dir="${path.www}typo3v4" />
		
		<!-- Reset the repository (optional) -->
		<!-- <delete dir="${path.source}${version}" /> -->
		<download repository="${repository}" target="${path.source}${version}" tagName="${tagName}" submoduleDirectory="${path.source}${version}/typo3/sysext" />
		
		<!-- Reset the API (recommanded) -->
		<delete dir="${path.build.api}${version}" />
		<delete>
			<fileset dir="${path.temporary}">
				<include name="*.conf" />
			</fileset>
		</delete>
		<!-- Generate the Doxygen API -->
		<doxygen source="${path.source}${version}" target="${path.build.api}${version}" tagName="${tagNameDisplay}" />
		
		<!-- Archive -->
		<archive source="${path.build.api}${version}" target="${path.build.archive}" version="${version}" />
		
		<!-- Deploy -->
		<deploy version="${version}" deployPath="${deployPath}" deployPathName="${deployPathName}" current="true"/>
		
		<echo>OK</echo>
	</target>
	
	
	<!-- DEPLOY REMOTE -->
	<target name="deploy-typo3-4-5" depends="">
		<echo>----------------------------------------</echo>
		<echo>| Deploying remotely TYPO3 4.5 API      |</echo>
		<echo>----------------------------------------</echo>
		
		<property name="version" value="typo3_src-4.5"/>
		<property name="tagName" value="TYPO3_4-5-5"/>
		<property name="tagNameDisplay" value="4.5.5"/>
		<property name="deployPath" value="typo3v4"/>
		<property name="deployPathName" value="45"/>
		
		<!-- Copy the archive to the server -->
		<commandLocal command="scp -q ${path.build.archive}${version}.zip ${server.credentials}:${site.remote.directory}www/archives/ "/>
		
		<!-- Decompress the archive to the server -->
		<commandRemote credentials="${server.credentials}" command="unzip -qq ${site.remote.directory}www/archives/${version}.zip "/>
		<commandRemote credentials="${server.credentials}" command="mv ${site.remote.directory}home/${version} ${site.remote.directory}www/typo3v4/${deployPathName}"/>
		
		<commandRemote credentials="${server.credentials}" command="unzip -qq ${site.remote.directory}www/archives/${version}.zip "/>
		<commandRemote credentials="${server.credentials}" command="mv ${site.remote.directory}home/${version} ${site.remote.directory}www/typo3v4/current"/>
		
		<echo>OK</echo>
	</target>
	
</project>
